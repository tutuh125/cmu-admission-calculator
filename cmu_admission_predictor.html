import React, { useState, useEffect } from 'react';
import * as tf from 'tensorflow';

const CMUAdmissionPredictor = () => {
  const [model, setModel] = useState(null);
  const [isTraining, setIsTraining] = useState(false);
  const [gpa, setGpa] = useState('4.0');
  const [testScore, setTestScore] = useState('1500');
  const [scoreType, setScoreType] = useState('SAT');
  const [applicationPlan, setApplicationPlan] = useState('RD');
  const [prediction, setPrediction] = useState(null);
  const [modelMetrics, setModelMetrics] = useState(null);

  // Your actual school data
  const rawData = [
    {sat: 1520, gpa: 4.43, plan: 'RD', decision: 'ACCEPTED'},
    {sat: 1580, gpa: 4.38, plan: 'RD', decision: 'ACCEPTED'},
    {sat: 1460, gpa: 4.19, plan: 'RD', decision: 'ACCEPTED'},
    {sat: 1520, gpa: 3.98, plan: 'ED', decision: 'ACCEPTED'},
    {sat: 1520, gpa: 3.96, plan: 'RD', decision: 'ACCEPTED'},
    {sat: 1580, gpa: 4.17, plan: 'RD', decision: 'ACCEPTED'},
    {sat: 1540, gpa: 3.98, plan: 'RD', decision: 'ACCEPTED'},
    {sat: 1540, gpa: 4.33, plan: 'RD', decision: 'WAITLISTED'},
    {sat: 1570, gpa: 4.15, plan: 'RD', decision: 'WAITLISTED'},
    {sat: 1540, gpa: 4.1, plan: 'RD', decision: 'WAITLISTED'},
    {sat: 1510, gpa: 4.16, plan: 'RD', decision: 'DENIED'},
    {sat: 1530, gpa: 3.99, plan: 'RD', decision: 'DENIED'},
    {sat: 1530, gpa: 3.87, plan: 'ED', decision: 'DENIED'},
    {sat: 1430, gpa: 4.05, plan: 'RD', decision: 'DENIED'},
    {sat: 1530, gpa: 3.87, plan: 'ED', decision: 'DENIED'},
    {sat: 1580, gpa: 3.84, plan: 'RD', decision: 'WAITLISTED'},
    {sat: 1570, gpa: 3.8, plan: 'RD', decision: 'WAITLISTED'},
    {sat: 1550, gpa: 3.83, plan: 'RD', decision: 'DENIED'},
    {sat: 1410, gpa: 3.7, plan: 'ED', decision: 'DENIED'},
    {sat: 1460, gpa: 3.68, plan: 'RD', decision: 'DENIED'},
    {sat: 1380, gpa: 3.79, plan: 'RD', decision: 'DENIED'},
    {sat: 1310, gpa: 3.79, plan: 'RD', decision: 'WAITLISTED'},
    // ACT scores converted to approximate SAT equivalent
    {sat: 1520, gpa: 4.16, plan: 'RD', decision: 'DENIED'}, // ACT 34
    {sat: 1520, gpa: 3.89, plan: 'RD', decision: 'WAITLISTED'}, // ACT 34
    {sat: 1520, gpa: 3.83, plan: 'RD', decision: 'DENIED'} // ACT 34
  ];

  // Convert ACT to SAT equivalent
  const actToSat = (actScore) => {
    const conversion = {
      36: 1590, 35: 1540, 34: 1520, 33: 1490, 32: 1460,
      31: 1430, 30: 1400, 29: 1370, 28: 1340, 27: 1310
    };
    return conversion[actScore] || actScore;
  };

  // Preprocess data for neural network
  const preprocessData = () => {
    const processedData = rawData.map(item => ({
      sat: item.sat,
      gpa: item.gpa,
      isED: item.plan === 'ED' ? 1 : 0,
      accepted: item.decision === 'ACCEPTED' ? 1 : 0
    }));

    // Normalize features
    const satScores = processedData.map(d => d.sat);
    const gpas = processedData.map(d => d.gpa);
    
    const satMin = Math.min(...satScores);
    const satMax = Math.max(...satScores);
    const gpaMin = Math.min(...gpas);
    const gpaMax = Math.max(...gpas);

    const normalizedData = processedData.map(item => ({
      sat: (item.sat - satMin) / (satMax - satMin),
      gpa: (item.gpa - gpaMin) / (gpaMax - gpaMin),
      isED: item.isED,
      accepted: item.accepted
    }));

    return { normalizedData, satMin, satMax, gpaMin, gpaMax };
  };

  // Build and train the neural network
  const buildAndTrainModel = async () => {
    setIsTraining(true);
    
    const { normalizedData, satMin, satMax, gpaMin, gpaMax } = preprocessData();
    
    // Prepare training data
    const features = normalizedData.map(d => [d.sat, d.gpa, d.isED]);
    const labels = normalizedData.map(d => [d.accepted]);
    
    const xs = tf.tensor2d(features);
    const ys = tf.tensor2d(labels);
    
    // Build neural network
    const model = tf.sequential({
      layers: [
        tf.layers.dense({
          inputShape: [3],
          units: 16,
          activation: 'relu'
        }),
        tf.layers.dropout({ rate: 0.3 }),
        tf.layers.dense({
          units: 8,
          activation: 'relu'
        }),
        tf.layers.dropout({ rate: 0.3 }),
        tf.layers.dense({
          units: 4,
          activation: 'relu'
        }),
        tf.layers.dense({
          units: 1,
          activation: 'sigmoid'
        })
      ]
    });
    
    model.compile({
      optimizer: tf.train.adam(0.01),
      loss: 'binaryCrossentropy',
      metrics: ['accuracy']
    });
    
    // Train the model
    const history = await model.fit(xs, ys, {
      epochs: 200,
      validationSplit: 0.2,
      shuffle: true,
      batchSize: 4
    });
    
    // Store normalization parameters with model
    model.normParams = { satMin, satMax, gpaMin, gpaMax };
    
    setModel(model);
    setIsTraining(false);
    
    // Calculate final metrics
    const finalAccuracy = history.history.accuracy[history.history.accuracy.length - 1];
    const finalLoss = history.history.loss[history.history.loss.length - 1];
    
    setModelMetrics({
      accuracy: (finalAccuracy * 100).toFixed(1),
      loss: finalLoss.toFixed(4),
      epochs: history.history.accuracy.length
    });
    
    // Clean up tensors
    xs.dispose();
    ys.dispose();
  };

  // Make prediction
  const makePrediction = () => {
    if (!model) return;
    
    let normalizedSat, normalizedGpa;
    
    if (scoreType === 'ACT') {
      const satEquivalent = actToSat(parseInt(testScore));
      normalizedSat = (satEquivalent - model.normParams.satMin) / 
                      (model.normParams.satMax - model.normParams.satMin);
    } else {
      normalizedSat = (parseInt(testScore) - model.normParams.satMin) / 
                      (model.normParams.satMax - model.normParams.satMin);
    }
    
    normalizedGpa = (parseFloat(gpa) - model.normParams.gpaMin) / 
                    (model.normParams.gpaMax - model.normParams.gpaMin);
    
    const isED = applicationPlan === 'ED' ? 1 : 0;
    
    const inputTensor = tf.tensor2d([[normalizedSat, normalizedGpa, isED]]);
    const predictionTensor = model.predict(inputTensor);
    
    predictionTensor.data().then(result => {
      const probability = result[0] * 100;
      setPrediction(probability);
    });
    
    inputTensor.dispose();
    predictionTensor.dispose();
  };

  useEffect(() => {
    buildAndTrainModel();
  }, []);

  const getStatistics = () => {
    const accepted = rawData.filter(d => d.decision === 'ACCEPTED');
    const waitlisted = rawData.filter(d => d.decision === 'WAITLISTED');
    const denied = rawData.filter(d => d.decision === 'DENIED');
    
    return {
      totalApplications: rawData.length,
      acceptanceRate: ((accepted.length / rawData.length) * 100).toFixed(1),
      waitlistRate: ((waitlisted.length / rawData.length) * 100).toFixed(1),
      avgAcceptedGPA: (accepted.reduce((sum, d) => sum + d.gpa, 0) / accepted.length).toFixed(2),
      avgAcceptedSAT: Math.round(accepted.reduce((sum, d) => sum + d.sat, 0) / accepted.length)
    };
  };

  const stats = getStatistics();

  return (
    <div className="max-w-4xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
      <div className="bg-white rounded-xl shadow-lg p-8">
        <h1 className="text-3xl font-bold text-center text-gray-800 mb-8">
          Carnegie Mellon Admission Predictor
        </h1>
        
        {/* Data Statistics */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
          <div className="bg-blue-100 p-4 rounded-lg">
            <div className="text-2xl font-bold text-blue-700">{stats.totalApplications}</div>
            <div className="text-sm text-gray-600">Total Applications</div>
          </div>
          <div className="bg-green-100 p-4 rounded-lg">
            <div className="text-2xl font-bold text-green-700">{stats.acceptanceRate}%</div>
            <div className="text-sm text-gray-600">Acceptance Rate</div>
          </div>
          <div className="bg-yellow-100 p-4 rounded-lg">
            <div className="text-2xl font-bold text-yellow-700">{stats.avgAcceptedGPA}</div>
            <div className="text-sm text-gray-600">Avg Accepted GPA</div>
          </div>
          <div className="bg-purple-100 p-4 rounded-lg">
            <div className="text-2xl font-bold text-purple-700">{stats.avgAcceptedSAT}</div>
            <div className="text-sm text-gray-600">Avg Accepted SAT</div>
          </div>
        </div>

        {/* Model Status */}
        {isTraining && (
          <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-6">
            <div className="flex items-center">
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-700 mr-2"></div>
              Training neural network model...
            </div>
          </div>
        )}

        {modelMetrics && (
          <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
            Model trained successfully! Accuracy: {modelMetrics.accuracy}% | Loss: {modelMetrics.loss} | Epochs: {modelMetrics.epochs}
          </div>
        )}

        {/* Input Form */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Weighted GPA
            </label>
            <input
              type="number"
              step="0.01"
              min="0"
              max="5"
              value={gpa}
              onChange={(e) => setGpa(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="e.g., 4.0"
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Test Score Type
            </label>
            <select
              value={scoreType}
              onChange={(e) => setScoreType(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="SAT">SAT</option>
              <option value="ACT">ACT</option>
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {scoreType} Score
            </label>
            <input
              type="number"
              min={scoreType === 'SAT' ? '400' : '1'}
              max={scoreType === 'SAT' ? '1600' : '36'}
              value={testScore}
              onChange={(e) => setTestScore(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder={scoreType === 'SAT' ? 'e.g., 1500' : 'e.g., 34'}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Application Plan
            </label>
            <select
              value={applicationPlan}
              onChange={(e) => setApplicationPlan(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="RD">Regular Decision (RD)</option>
              <option value="ED">Early Decision (ED)</option>
            </select>
          </div>
        </div>

        {/* Predict Button */}
        <div className="text-center mb-8">
          <button
            onClick={makePrediction}
            disabled={!model || isTraining}
            className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors"
          >
            {isTraining ? 'Training Model...' : 'Predict Admission Chance'}
          </button>
        </div>

        {/* Prediction Result */}
        {prediction !== null && (
          <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-lg text-center">
            <h2 className="text-2xl font-bold mb-2">Prediction Result</h2>
            <div className="text-4xl font-bold mb-2">{prediction.toFixed(1)}%</div>
            <div className="text-lg">Estimated chance of admission to Carnegie Mellon</div>
            
            {/* Interpretation */}
            <div className="mt-4 text-sm">
              {prediction >= 70 ? '🟢 Strong candidate' :
               prediction >= 40 ? '🟡 Competitive candidate' :
               prediction >= 20 ? '🟠 Reach school' : '🔴 High reach'}
            </div>
          </div>
        )}

        {/* Model Information */}
        <div className="mt-8 p-4 bg-gray-100 rounded-lg">
          <h3 className="font-bold text-gray-800 mb-2">Model Information</h3>
          <p className="text-sm text-gray-600">
            This neural network was trained on {rawData.length} actual admission records from your school to Carnegie Mellon. 
            The model considers weighted GPA, test scores (SAT/ACT), and application timing (ED vs RD) to predict admission probability.
            Results are estimates based on historical patterns and should be used as guidance alongside other factors.
          </p>
        </div>
      </div>
    </div>
  );
};

export default CMUAdmissionPredictor;
